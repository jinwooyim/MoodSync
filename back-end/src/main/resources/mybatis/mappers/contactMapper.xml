
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.contact.dao.ContactDAO">
    <insert id="createContact" parameterType="map">
        <selectKey keyProperty="contactId" resultType="int" order="BEFORE">
            SELECT NVL(MAX(CONTACTID), 0) + 1 FROM user_contact
        </selectKey>
        INSERT INTO user_contact(CONTACTID, USERNUMBER, CONTACT_TITLE, CONTACT_CONTENT, CREATED_DATE) 
        VALUES(#{contactId}, #{userNumber}, #{contact_title}, #{contact_content}, SYSDATE)
    </insert>
	<select id="readContact">
		SELECT CONTACTID
		FROM user_contact
		WHERE USERNUMBER = #{userNumber}
		AND CONTACT_TITLE = #{contact_title}
		AND CONTACT_CONTENT = #{contact_content}
		AND ROWNUM = 1
	</select>
	<update id="updateContact">
		UPDATE user_contact
		SET CONTACT_TITLE = #{contact_title},
		CONTACT_CONTENT = #{contact_content},
		UPDATED_DATE = SYSDATE
		WHERE USERNUMBER = #{userNumber}
		AND CONTACT_TITLE = #{contact_title}
		AND CONTACT_CONTENT = #{contact_content}
	</update>
	<update id="deleteContact">
	    UPDATE user_contact 
        SET STATUS = 'DELETED',
        DELETED_DATE = SYSDATE
        WHERE USERNUMBER = #{userNumber} 
        AND CONTACT_TITLE = #{contact_title} 
        AND CONTACT_CONTENT = #{contact_content}
	</update>
	<select id="allReadContact" parameterType="com.boot.z_page.criteria.CriteriaDTO" resultType="com.boot.contact.dto.ContactDTO">
        <![CDATA[
        SELECT contactId, userNumber, contactTitle, contactContent
        FROM (
            SELECT rownum as rn, contactId, userNumber, contactTitle, contactContent
            FROM (
                SELECT CONTACTID as contactId,
                       USERNUMBER as userNumber,
                       CONTACT_TITLE as contactTitle,
                       CONTACT_CONTENT as contactContent
                FROM user_contact
                WHERE NVL(STATUS, 'ACTIVE') != 'DELETED'
                ORDER BY CONTACTID DESC
            ) a
            WHERE rownum <= (#{pageNum} * #{amount})
        ) aa
        WHERE rn > (#{pageNum} - 1) * #{amount}
        ]]>
    </select>
    <select id="getTotalCount" parameterType="com.boot.z_page.criteria.CriteriaDTO" resultType="int">
        SELECT COUNT(*) 
        FROM user_contact 
        WHERE NVL(STATUS, 'ACTIVE') != 'DELETED'
    </select>
</mapper>

